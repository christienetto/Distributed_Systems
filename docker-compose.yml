version: "3.9"

services:
  mongodb:
    image: mongo:7
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    container_name: mongodb
    ports:
      - "27017:27017"
    healthcheck:
      test:
        ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Mongo change stream only works with replica sets
  # See e.g., https://stackoverflow.com/questions/59571945/the-changestream-stage-is-only-supported-on-replica-sets-error-while-using-mo
  mongo-init-replica:
    image: mongo:7
    container_name: mongo-init-replica
    depends_on:
      mongodb:
        condition: service_healthy
    restart: "no"
    environment:
      - MONGO_REPLICA_HOST=${MONGO_REPLICA_HOST:-mongodb:27017}
    entrypoint:
      - sh
      - -c
      - |
        HOST="$${MONGO_REPLICA_HOST:-mongodb:27017}"
        mongosh --host "$${HOST}" --eval "try { rs.initiate({_id: 'rs0', members: [{ _id: 0, host: '$${HOST}' }]}); } catch (e) { if (e.codeName !== 'AlreadyInitialized') { throw e; } }"

  server:
    build:
      context: .
      dockerfile: code/server/Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-}
        VITE_WS_BASE: ${VITE_WS_BASE:-}
    container_name: python_server
    depends_on:
      mongo-init-replica:
        condition: service_completed_successfully
    ports:
      - "8000:8000"
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongodb:27017/?replicaSet=rs0}
